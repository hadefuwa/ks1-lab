<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lesson 82: Subtraction Survival</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family:'Fredoka',sans-serif; background: linear-gradient(135deg,#1c1917 0%,#44403c 100%); min-height:100vh; display:flex; flex-direction:column; align-items:center; color:white; user-select:none; overflow:hidden; }
        #hud { position:absolute; top:18px; left:0; width:100%; display:flex; justify-content:space-between; align-items:center; padding:0 24px; z-index:10; }
        #timer-bar-wrap { position:absolute; top:0; left:0; width:100%; height:6px; z-index:20; }
        #timer-bar { height:100%; background:#ef4444; transition:width 0.1s linear; width:100%; }
        #question-display { position:absolute; top:60px; left:50%; transform:translateX(-50%); font-size:3rem; font-weight:600; color:#fde68a; text-shadow:0 2px 8px rgba(0,0,0,0.5); z-index:10; white-space:nowrap; }
        #arena { position:absolute; top:0; left:0; right:0; bottom:0; overflow:hidden; }
        .balloon { position:absolute; bottom:-120px; display:flex; flex-direction:column; align-items:center; cursor:pointer; }
        .balloon-body { width:80px; height:96px; border-radius:50% 50% 50% 50%/60% 60% 40% 40%; display:flex; align-items:center; justify-content:center; font-size:1.8rem; font-weight:700; color:white; text-shadow:0 1px 3px rgba(0,0,0,0.5); box-shadow:-6px -6px 0 rgba(255,255,255,0.2) inset,4px 4px 10px rgba(0,0,0,0.3); }
        .balloon-knot { width:10px; height:10px; border-radius:50% 50% 0 0; margin-top:-2px; }
        .balloon-string { width:2px; height:36px; background:rgba(255,255,255,0.5); }
        @keyframes popAnim { 0%{transform:scale(1);opacity:1} 50%{transform:scale(1.6);opacity:0.6} 100%{transform:scale(0);opacity:0} }
        .balloon.pop { animation:popAnim 0.25s ease forwards; pointer-events:none; }
        .screen { position:fixed; top:0; left:0; width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; background:rgba(28,25,23,0.97); z-index:50; text-align:center; padding:20px; }
        .hidden { display:none !important; }
        .big-btn { background:linear-gradient(135deg,#78716c,#57534e); border:none; padding:14px 52px; font-size:1.8rem; color:white; border-radius:60px; cursor:pointer; box-shadow:0 8px 24px rgba(120,113,108,0.5); font-family:inherit; font-weight:600; transition:transform 0.2s; margin-top:1.2rem; }
        .big-btn:hover { transform:scale(1.05) translateY(-2px); }
        #game-container { position:relative; width:100%; height:100vh; display:flex; flex-direction:column; align-items:center; }
        #lives { font-size:1.4rem; }
    </style>
</head>
<body>
<div id="start-screen" class="screen">
    <h1 style="font-size:2.8rem;margin-bottom:0.5rem">üíÄ Survival Mode!</h1>
    <p style="color:#d6d3d1;font-size:1.2rem;margin-bottom:0.8rem">Pop the right answer before time runs out!<br>You have <strong>3 lives</strong>. Miss 3 questions and it's over!</p>
    <div style="font-size:3rem">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
    <button class="big-btn" onclick="startGame()">Survive! üí™</button>
</div>
<div id="end-screen" class="screen hidden">
    <h1 style="font-size:2.6rem" id="end-title">Game Over!</h1>
    <p style="color:#d6d3d1;font-size:1.2rem;margin:0.8rem 0" id="end-msg">You ran out of lives.</p>
    <div style="font-size:2rem;color:#fde68a;margin:0.8rem">Score: <strong id="final-score">0</strong></div>
    <div style="font-size:1.2rem;color:#a8a29e;margin-bottom:0.5rem">Questions: <span id="final-q">0</span></div>
    <button class="big-btn" onclick="finishLesson()">Finish ‚úÖ</button>
</div>
<div id="game-container" class="hidden">
    <div id="timer-bar-wrap"><div id="timer-bar"></div></div>
    <div id="hud">
        <div style="font-size:1.2rem;font-weight:600">Score <span id="score">0</span></div>
        <div id="lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
    </div>
    <div id="question-display">? ‚àí ? = ?</div>
    <div id="arena"></div>
</div>

<script>
const CONFIG = { lessonId:82, maxNum:20, speed:2.5, timePerQ:8000 };
const COLORS = ['#6b7280','#4b5563','#374151','#1f2937','#78716c','#57534e','#44403c','#292524'];
const state = { score:0, qNum:0, lives:3, correct:0, balloons:[], animating:false, rafId:null, timerAnim:null, timerStart:0, gameOver:false };

const HEARTS = ['','‚ù§Ô∏è','‚ù§Ô∏è‚ù§Ô∏è','‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è'];

function startGame() {
    document.getElementById('start-screen').classList.add('hidden');
    document.getElementById('game-container').classList.remove('hidden');
    nextQuestion();
}

function nextQuestion() {
    if (state.gameOver) return;
    state.qNum++;
    clearBalloons();
    const b = Math.floor(Math.random() * CONFIG.maxNum) + 1;
    const a = b + Math.floor(Math.random() * CONFIG.maxNum) + 1;
    state.correct = a - b;
    document.getElementById('question-display').innerText = `${a} ‚àí ${b} = ?`;
    const answers = genAnswers(state.correct);
    spawnBalloons(answers);
    startTimer();
}

function genAnswers(correct) {
    const s = new Set([correct]);
    while (s.size < 4) { const w = correct + (Math.floor(Math.random()*6)+1) * (Math.random()<0.5?1:-1); if (w>0) s.add(w); }
    return [...s].sort(()=>Math.random()-0.5);
}

function startTimer() {
    clearTimer();
    state.timerStart = performance.now();
    const bar = document.getElementById('timer-bar');
    bar.style.transition = 'none'; bar.style.width = '100%';
    requestAnimationFrame(()=>{
        bar.style.transition = `width ${CONFIG.timePerQ}ms linear`;
        bar.style.width = '0%';
    });
    state.timerAnim = setTimeout(timeUp, CONFIG.timePerQ);
}

function clearTimer() {
    if (state.timerAnim) { clearTimeout(state.timerAnim); state.timerAnim = null; }
}

function timeUp() {
    if (state.gameOver || state.animating) return;
    loseLife();
}

function loseLife() {
    state.lives--;
    document.getElementById('lives').innerText = HEARTS[state.lives] || '';
    if (state.lives <= 0) {
        state.gameOver = true;
        endGame(false);
    } else {
        clearBalloons();
        nextQuestion();
    }
}

function spawnBalloons(answers) {
    const arena = document.getElementById('arena');
    const W = window.innerWidth;
    const positions = answers.map((_,i)=>(i+0.5)*(W/answers.length)).sort(()=>Math.random()-0.5);
    answers.forEach((val,i)=>{
        const el = document.createElement('div');
        el.className = 'balloon';
        const c = COLORS[Math.floor(Math.random()*COLORS.length)];
        el.innerHTML = `<div class="balloon-body" style="background:${c}">${val}</div><div class="balloon-knot" style="background:${c}"></div><div class="balloon-string"></div>`;
        el.style.left = `${positions[i]-40}px`;
        el.style.bottom = '-120px';
        el.onclick = ()=>tapBalloon(el, val);
        arena.appendChild(el);
        state.balloons.push({el,val,y:window.innerHeight+100});
    });
    if (state.rafId) cancelAnimationFrame(state.rafId);
    state.rafId = requestAnimationFrame(loop);
}

function loop() {
    state.balloons = state.balloons.filter(b=>b.el.parentNode);
    state.balloons.forEach(b=>{ b.y -= CONFIG.speed; b.el.style.bottom=`${window.innerHeight-b.y}px`; });
    if (state.balloons.length === 0 && !state.gameOver) timeUp();
    else if (!state.gameOver) state.rafId = requestAnimationFrame(loop);
}

function tapBalloon(el, val) {
    if (state.animating || state.gameOver) return;
    if (val === state.correct) {
        state.animating = true;
        clearTimer();
        state.score += 10;
        document.getElementById('score').innerText = state.score;
        el.classList.add('pop');
        confetti({particleCount:40,spread:70,origin:{x:(el.getBoundingClientRect().left+40)/window.innerWidth,y:el.getBoundingClientRect().top/window.innerHeight}});
        clearBalloons(true);
        setTimeout(()=>{ state.animating=false; nextQuestion(); }, 500);
    } else {
        el.style.filter='brightness(0.3)'; el.style.pointerEvents='none';
        setTimeout(()=>{ if(el.parentNode){el.style.filter='';el.style.pointerEvents='';} }, 400);
    }
}

function clearBalloons(keep) {
    if (state.rafId) { cancelAnimationFrame(state.rafId); state.rafId=null; }
    if (!keep) { state.balloons.forEach(b=>b.el.remove()); state.balloons=[]; }
}

function endGame(won) {
    clearBalloons(); clearTimer();
    document.getElementById('game-container').classList.add('hidden');
    document.getElementById('end-screen').classList.remove('hidden');
    document.getElementById('end-title').innerText = won ? 'üèÜ Champion!' : 'üíÄ Game Over!';
    document.getElementById('end-msg').innerText = won ? 'You survived!' : 'You ran out of lives.';
    document.getElementById('final-score').innerText = state.score;
    document.getElementById('final-q').innerText = state.qNum;
    if (won) confetti({particleCount:200,spread:120,origin:{y:0.5}});
}

function finishLesson() { window.parent.postMessage({type:'lessonCompleted',lessonId:CONFIG.lessonId},'*'); }
</script>
</body>
</html>
