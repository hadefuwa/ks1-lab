<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lesson 77: Subtract from 100</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Fredoka', sans-serif; background: linear-gradient(135deg, #3b0764 0%, #7e22ce 100%); min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; user-select: none; overflow: hidden; }
        h1 { font-size: 2rem; text-align: center; margin-bottom: 0.3rem; }
        #subtitle { color: #e9d5ff; font-size: 1.1rem; margin-bottom: 1.2rem; }
        #progress-bar-wrap { width: 320px; height: 10px; background: rgba(255,255,255,0.15); border-radius: 99px; margin-bottom: 1.5rem; overflow: hidden; }
        #progress-bar { height: 100%; background: #c084fc; border-radius: 99px; transition: width 0.5s; width: 0%; }
        #question-box { font-size: 3rem; font-weight: 600; color: #fde68a; margin-bottom: 1rem; text-align: center; min-height: 4rem; }
        #numberline-wrap { position: relative; width: 95vw; max-width: 680px; margin: 0 auto 0.8rem; }
        #nl-svg { width: 100%; height: 90px; overflow: visible; }
        /* Answer input for big numbers */
        #answer-area { display: flex; align-items: center; gap: 14px; margin-bottom: 1.2rem; }
        #answer-input { font-family: 'Fredoka', sans-serif; font-size: 2.2rem; width: 120px; padding: 10px 14px; border-radius: 14px; border: 3px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; text-align: center; outline: none; }
        #answer-input:focus { border-color: #c084fc; }
        #check-btn { background: linear-gradient(135deg, #9333ea, #7e22ce); border: none; padding: 12px 32px; font-size: 1.4rem; color: white; border-radius: 60px; cursor: pointer; font-family: inherit; font-weight: 600; box-shadow: 0 4px 14px rgba(147,51,234,0.4); transition: transform 0.2s; }
        #check-btn:hover { transform: scale(1.06); }
        #hint { font-size: 1rem; color: #e9d5ff; margin-bottom: 1rem; min-height: 1.4rem; text-align: center; }
        #message { font-size: 1.4rem; font-weight: 600; min-height: 2rem; text-align: center; margin-bottom: 0.8rem; }
        .msg-correct { color: #4ade80; }
        .msg-wrong { color: #f87171; animation: shake 0.4s; }
        @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-8px)} 75%{transform:translateX(8px)} }
        #score-display { font-size: 1.1rem; color: #e9d5ff; }
        .screen { position: fixed; top:0; left:0; width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; background:rgba(59,7,100,0.97); z-index:50; padding:20px; }
        .hidden { display: none !important; }
        .big-btn { background: linear-gradient(135deg, #9333ea, #7e22ce); border: none; padding: 14px 52px; font-size: 1.7rem; color: white; border-radius: 60px; cursor: pointer; box-shadow: 0 8px 20px rgba(147,51,234,0.5); font-family: inherit; font-weight: 600; transition: transform 0.2s; margin-top: 1.2rem; }
        .big-btn:hover { transform: scale(1.05) translateY(-2px); }
    </style>
</head>
<body>
<div id="start-screen" class="screen">
    <h1>‚ûñ Subtract from 100</h1>
    <p style="color:#e9d5ff;font-size:1.2rem;text-align:center;margin:0.8rem 0">The number line goes to 100!<br>Use the line to help, then type your answer.</p>
    <div style="font-size:4rem;margin:1rem 0">üê∏</div>
    <button class="big-btn" onclick="startGame()">Let's Go! üöÄ</button>
</div>
<div id="end-screen" class="screen hidden">
    <h1>üéâ Superstar!</h1>
    <p style="color:#e9d5ff;font-size:1.2rem;margin:0.8rem 0">You finished Subtract from 100!</p>
    <div style="font-size:1.8rem;color:#fde68a;margin:0.5rem 0">Score: <strong id="final-score">0</strong></div>
    <button class="big-btn" onclick="finishLesson()">Complete! ‚úÖ</button>
</div>

<h1>‚ûñ Subtract from 100</h1>
<div id="subtitle">Use the number line, then type your answer</div>
<div id="progress-bar-wrap"><div id="progress-bar"></div></div>
<div id="question-box">? ‚àí ? = ?</div>
<div id="numberline-wrap">
    <svg id="nl-svg" viewBox="0 0 680 90"></svg>
</div>
<div id="hint">Use the number line to help, then type below</div>
<div id="answer-area">
    <input id="answer-input" type="number" min="0" max="100" placeholder="?" oninput="onType()" onkeydown="if(event.key==='Enter')checkAnswer()">
    <button id="check-btn" onclick="checkAnswer()">Check ‚úì</button>
</div>
<div id="message"></div>
<div id="score-display">Score: <span id="score">0</span></div>

<script>
const LESSON_ID = 77;
const MAX = 100;
const STEP = 10;  // Divisions of 10
const TOTAL_Q = 10;
const SVG_W = 680;

let score = 0, qNum = 0, current = null;

function rnd(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

function startGame() {
    document.getElementById('start-screen').classList.add('hidden');
    nextQuestion();
}

function nextQuestion() {
    if (qNum >= TOTAL_Q) { endGame(); return; }
    qNum++;
    // Multiples of 10 subtraction
    const multiples = [10, 20, 30, 40, 50, 60, 70, 80, 90, 100];
    const a = multiples[rnd(2, multiples.length - 1)];
    const b = multiples[rnd(1, multiples.indexOf(a))];
    current = { a, b, answer: a - b };
    document.getElementById('question-box').innerText = `${a} ‚àí ${b} = ?`;
    document.getElementById('answer-input').value = '';
    document.getElementById('answer-input').disabled = false;
    setMessage('', '');
    updateProgress();
    drawNumberLine(a, false);
    document.getElementById('answer-input').focus();
}

function drawNumberLine(highlightStart, showAnswer) {
    const svg = document.getElementById('nl-svg');
    svg.innerHTML = '';
    const W = SVG_W, PAD = 26;
    const step = (W - 2 * PAD) / (MAX / STEP);

    const line = makeSVG('line', { x1: PAD, y1: 50, x2: W - PAD, y2: 50, stroke: 'rgba(255,255,255,0.35)', 'stroke-width': 3 });
    svg.appendChild(line);

    if (showAnswer) {
        const numHops = current.b / STEP;
        const startIdx = current.a / STEP;
        for (let i = 0; i < numHops; i++) {
            const x1 = PAD + (startIdx - i) * step;
            const x2 = PAD + (startIdx - i - 1) * step;
            const mx = (x1 + x2) / 2;
            const path = makeSVG('path', { d: `M ${x1} 50 Q ${mx} 18 ${x2} 50`, stroke: '#fbbf24', 'stroke-width': 2.5, fill: 'none', 'stroke-dasharray': '5,3' });
            svg.appendChild(path);
        }
    }

    for (let i = 0; i <= MAX / STEP; i++) {
        const val = i * STEP;
        const x = PAD + i * step;
        const isStart = val === current.a;
        const isAns = showAnswer && val === current.answer;
        const tick = makeSVG('line', { x1: x, y1: 43, x2: x, y2: 57, stroke: 'rgba(255,255,255,0.5)', 'stroke-width': 2 });
        svg.appendChild(tick);
        const dot = makeSVG('circle', { cx: x, cy: 50, r: isStart || isAns ? 16 : 13, fill: isStart ? '#f59e0b' : isAns ? '#4ade80' : 'rgba(255,255,255,0.1)', stroke: isStart ? '#fde68a' : 'rgba(255,255,255,0.25)', 'stroke-width': isStart ? 3 : 1.5 });
        svg.appendChild(dot);
        const label = makeSVG('text', { x, y: 76, 'text-anchor': 'middle', fill: 'white', 'font-family': 'Fredoka', 'font-size': 13, 'font-weight': 600 });
        label.textContent = val;
        svg.appendChild(label);
    }

    const frogX = PAD + (current.a / STEP) * step;
    const frog = makeSVG('text', { x: frogX, y: 28, 'text-anchor': 'middle', 'font-size': 20 });
    frog.textContent = 'üê∏';
    svg.appendChild(frog);
}

function makeSVG(tag, attrs) {
    const el = document.createElementNS('http://www.w3.org/2000/svg', tag);
    for (const [k, v] of Object.entries(attrs)) el.setAttribute(k, v);
    return el;
}

function onType() { setMessage('', ''); }

function checkAnswer() {
    const val = parseInt(document.getElementById('answer-input').value);
    if (isNaN(val)) return;
    document.getElementById('answer-input').disabled = true;
    if (val === current.answer) {
        score += 10;
        document.getElementById('score').innerText = score;
        setMessage('‚úÖ Correct! ' + current.a + ' ‚àí ' + current.b + ' = ' + current.answer, 'msg-correct');
        drawNumberLine(current.a, true);
        confetti({ particleCount: 50, spread: 60, origin: { y: 0.7 } });
        speak('Correct! Well done!');
        setTimeout(() => nextQuestion(), 1600);
    } else {
        setMessage('‚ùå Not quite. Try again!', 'msg-wrong');
        document.getElementById('answer-input').disabled = false;
        document.getElementById('answer-input').value = '';
        document.getElementById('answer-input').focus();
        speak('Not quite. Try again.');
    }
}

function setMessage(text, cls) { const el = document.getElementById('message'); el.innerText = text; el.className = cls; }
function updateProgress() { document.getElementById('progress-bar').style.width = `${((qNum - 1) / TOTAL_Q) * 100}%`; }

function endGame() {
    document.getElementById('progress-bar').style.width = '100%';
    document.getElementById('end-screen').classList.remove('hidden');
    document.getElementById('final-score').innerText = score;
    confetti({ particleCount: 180, spread: 100, origin: { y: 0.5 } });
    speak('Superstar! You finished subtract from one hundred!');
}
function finishLesson() { window.parent.postMessage({ type: 'lessonCompleted', lessonId: LESSON_ID }, '*'); }
function speak(text) { if (window.speechSynthesis.speaking) window.speechSynthesis.cancel(); window.speechSynthesis.speak(new SpeechSynthesisUtterance(text)); }
</script>
</body>
</html>
