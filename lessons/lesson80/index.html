<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lesson 80: 3-Digit Subtraction</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Fredoka', sans-serif; background: linear-gradient(135deg, #052e16 0%, #166534 100%); min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; user-select: none; overflow: hidden; }
        h1 { font-size: 2rem; text-align: center; margin-bottom: 0.3rem; }
        #subtitle { color: #bbf7d0; font-size: 1.1rem; margin-bottom: 1.5rem; }
        #progress-bar-wrap { width: 320px; height: 10px; background: rgba(255,255,255,0.15); border-radius: 99px; margin-bottom: 1.5rem; overflow: hidden; }
        #progress-bar { height: 100%; background: #4ade80; border-radius: 99px; transition: width 0.5s; width: 0%; }
        .column-box { background: rgba(255,255,255,0.08); border-radius: 20px; padding: 24px 28px; display: inline-grid; grid-template-columns: 1fr 1fr 1fr; gap: 0 6px; align-items: center; border: 2px solid rgba(255,255,255,0.15); margin-bottom: 1.5rem; }
        .col-label { font-size: 0.85rem; color: #86efac; text-align: center; padding-bottom: 8px; }
        .col-num { font-size: 2.8rem; font-weight: 700; color: white; text-align: center; width: 60px; line-height: 1.2; }
        .minus-row { font-size: 2rem; color: #f87171; font-weight: 700; display: flex; justify-content: flex-end; grid-column: span 3; border-top: 3px solid rgba(255,255,255,0.3); padding-top: 8px; margin-top: 4px; gap: 6px; }
        .answer-row { display: flex; gap: 6px; grid-column: span 3; justify-content: flex-end; margin-top: 8px; }
        .digit-input { width: 60px; height: 62px; font-size: 2.6rem; font-weight: 700; text-align: center; background: rgba(255,255,255,0.12); border: 3px solid rgba(255,255,255,0.25); border-radius: 12px; color: white; font-family: 'Fredoka', sans-serif; outline: none; }
        .digit-input:focus { border-color: #4ade80; background: rgba(74,222,128,0.1); }
        .digit-input.correct { border-color: #4ade80; background: rgba(74,222,128,0.15); }
        .digit-input.wrong { border-color: #f87171; animation: shake 0.4s; }
        @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-6px)} 75%{transform:translateX(6px)} }
        #check-btn { background: linear-gradient(135deg, #16a34a, #166534); border: none; padding: 14px 52px; font-size: 1.7rem; color: white; border-radius: 60px; cursor: pointer; box-shadow: 0 6px 18px rgba(22,163,74,0.4); font-family: inherit; font-weight: 600; transition: transform 0.2s; }
        #check-btn:hover { transform: scale(1.05); }
        #message { font-size: 1.4rem; font-weight: 600; min-height: 2rem; text-align: center; margin: 1rem 0 0.5rem; }
        .msg-correct { color: #4ade80; }
        .msg-wrong { color: #f87171; }
        #score-display { font-size: 1.1rem; color: #bbf7d0; }
        .screen { position: fixed; top:0; left:0; width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; background:rgba(5,46,22,0.97); z-index:50; padding:20px; }
        .hidden { display: none !important; }
        .big-btn { background: linear-gradient(135deg, #16a34a, #166534); border: none; padding: 14px 52px; font-size: 1.7rem; color: white; border-radius: 60px; cursor: pointer; box-shadow: 0 8px 20px rgba(22,163,74,0.5); font-family: inherit; font-weight: 600; transition: transform 0.2s; margin-top: 1.2rem; }
        .big-btn:hover { transform: scale(1.05) translateY(-2px); }
    </style>
</head>
<body>
<div id="start-screen" class="screen">
    <h1>‚ûñ 3-Digit Subtraction</h1>
    <p style="color:#bbf7d0;font-size:1.2rem;text-align:center;margin:0.8rem 0">Now we subtract hundreds, tens AND ones!<br>Type each digit in the answer boxes.</p>
    <div style="font-size:3.5rem;margin:1rem 0">üìê</div>
    <button class="big-btn" onclick="startGame()">Let's Go!</button>
</div>
<div id="end-screen" class="screen hidden">
    <h1>üéâ Champion!</h1>
    <p style="color:#bbf7d0;font-size:1.2rem;margin:0.8rem 0">You completed 3-Digit Subtraction!</p>
    <div style="font-size:1.8rem;color:#fde68a;margin:0.5rem 0">Score: <strong id="final-score">0</strong></div>
    <button class="big-btn" onclick="finishLesson()">Complete! ‚úÖ</button>
</div>

<h1>‚ûñ 3-Digit Subtraction</h1>
<div id="subtitle">Type each digit in the answer boxes</div>
<div id="progress-bar-wrap"><div id="progress-bar"></div></div>

<div class="column-box">
    <div class="col-label">Hundreds</div><div class="col-label">Tens</div><div class="col-label">Ones</div>
    <div class="col-num" id="a-h">0</div><div class="col-num" id="a-t">0</div><div class="col-num" id="a-o">0</div>
    <div class="minus-row">‚àí&nbsp;<span id="b-h">0</span>&nbsp;<span id="b-t">0</span>&nbsp;<span id="b-o">0</span></div>
    <div class="answer-row">
        <input class="digit-input" id="ans-h" type="number" min="0" max="9" placeholder="?" onkeydown="handleKey(event,'ans-h')" oninput="limitOne(this)">
        <input class="digit-input" id="ans-t" type="number" min="0" max="9" placeholder="?" onkeydown="handleKey(event,'ans-t')" oninput="limitOne(this)">
        <input class="digit-input" id="ans-o" type="number" min="0" max="9" placeholder="?" onkeydown="handleKey(event,'ans-o')" oninput="limitOne(this)">
    </div>
</div>

<button id="check-btn" onclick="checkAnswer()">Check ‚úì</button>
<div id="message"></div>
<div id="score-display">Score: <span id="score">0</span></div>

<script>
const LESSON_ID = 80;
const TOTAL_Q = 10;
let score = 0, qNum = 0, current = null;

function rnd(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

function startGame() { document.getElementById('start-screen').classList.add('hidden'); nextQuestion(); }

function nextQuestion() {
    if (qNum >= TOTAL_Q) { endGame(); return; }
    qNum++;
    // No borrowing: each column of a >= b
    let aH, aT, aO, bH, bT, bO;
    do {
        aH = rnd(2, 9); aT = rnd(0, 9); aO = rnd(0, 9);
        bH = rnd(1, aH - 1); bT = rnd(0, aT); bO = rnd(0, aO);
    } while (aH * 100 + aT * 10 + aO <= bH * 100 + bT * 10 + bO);
    const a = aH*100 + aT*10 + aO;
    const b = bH*100 + bT*10 + bO;
    current = { a, b, answer: a - b, aH, aT, aO, bH, bT, bO };

    document.getElementById('a-h').innerText = aH;
    document.getElementById('a-t').innerText = aT;
    document.getElementById('a-o').innerText = aO;
    document.getElementById('b-h').innerText = bH;
    document.getElementById('b-t').innerText = bT;
    document.getElementById('b-o').innerText = bO;

    ['ans-h','ans-t','ans-o'].forEach(id => { const el = document.getElementById(id); el.value = ''; el.className = 'digit-input'; el.disabled = false; });
    setMessage('', '');
    updateProgress();
    document.getElementById('ans-h').focus();
    speak(`${a} minus ${b}`);
}

function limitOne(el) { if (el.value.length > 1) el.value = el.value.slice(-1); }
function handleKey(e, id) {
    if (e.key === 'Enter') {
        const order = ['ans-h','ans-t','ans-o'];
        const idx = order.indexOf(id);
        if (idx < order.length - 1) document.getElementById(order[idx + 1]).focus();
        else checkAnswer();
    }
}

function checkAnswer() {
    const hV = parseInt(document.getElementById('ans-h').value);
    const tV = parseInt(document.getElementById('ans-t').value);
    const oV = parseInt(document.getElementById('ans-o').value);
    if ([hV, tV, oV].some(isNaN)) return;
    const cH = Math.floor(current.answer / 100);
    const cT = Math.floor((current.answer % 100) / 10);
    const cO = current.answer % 10;
    const ok = [hV === cH, tV === cT, oV === cO];
    ['ans-h','ans-t','ans-o'].forEach((id, i) => { document.getElementById(id).className = 'digit-input ' + (ok[i] ? 'correct' : 'wrong'); });
    if (ok.every(Boolean)) {
        score += 10; document.getElementById('score').innerText = score;
        setMessage('‚úÖ Correct! ' + current.a + ' ‚àí ' + current.b + ' = ' + current.answer, 'msg-correct');
        ['ans-h','ans-t','ans-o'].forEach(id => document.getElementById(id).disabled = true);
        confetti({ particleCount: 60, spread: 70, origin: { y: 0.7 } });
        speak('Correct! Well done!');
        setTimeout(() => nextQuestion(), 1400);
    } else {
        setMessage('‚ùå Not quite ‚Äî try again!', 'msg-wrong');
        speak('Not quite. Try again.');
        setTimeout(() => {
            ['ans-h','ans-t','ans-o'].forEach(id => { const el = document.getElementById(id); el.value = ''; el.className = 'digit-input'; });
            setMessage('', '');
            document.getElementById('ans-h').focus();
        }, 900);
    }
}

function setMessage(text, cls) { const el = document.getElementById('message'); el.innerText = text; el.className = cls; }
function updateProgress() { document.getElementById('progress-bar').style.width = `${((qNum-1)/TOTAL_Q)*100}%`; }

function endGame() {
    document.getElementById('progress-bar').style.width = '100%';
    document.getElementById('end-screen').classList.remove('hidden');
    document.getElementById('final-score').innerText = score;
    confetti({ particleCount: 180, spread: 100, origin: { y: 0.5 } });
    speak('Champion! You finished three digit subtraction!');
}
function finishLesson() { window.parent.postMessage({ type: 'lessonCompleted', lessonId: LESSON_ID }, '*'); }
function speak(text) { if (window.speechSynthesis.speaking) window.speechSynthesis.cancel(); window.speechSynthesis.speak(new SpeechSynthesisUtterance(text)); }
</script>
</body>
</html>
